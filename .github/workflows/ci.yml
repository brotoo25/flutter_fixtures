name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        flutter-version: ['stable', 'beta']
      fail-fast: false

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ matrix.flutter-version }}
        channel: ${{ matrix.flutter-version }}
        cache: true

    - name: Get dependencies
      run: flutter pub get

    - name: Verify formatting
      run: dart format --output=none --set-exit-if-changed .

    - name: Analyze project source
      run: flutter analyze

    - name: Run tests
      run: flutter test

    - name: Test individual packages
      run: |
        echo "Testing flutter_fixtures_core..."
        cd packages/flutter_fixtures_core
        flutter test
        cd ../..
        
        echo "Testing flutter_fixtures_dio..."
        cd packages/flutter_fixtures_dio
        flutter test
        cd ../..
        
        echo "Testing flutter_fixtures_ui..."
        cd packages/flutter_fixtures_ui
        flutter test
        cd ../..
        
        echo "Testing flutter_fixtures..."
        cd packages/flutter_fixtures
        flutter test
        cd ../..

    - name: Build example app
      run: |
        cd example
        flutter build apk --debug

  package-analysis:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: 'stable'
        channel: 'stable'
        cache: true

    - name: Get dependencies
      run: flutter pub get

    - name: Check package scores
      run: |
        dart pub global activate pana
        echo "Analyzing flutter_fixtures_core..."
        cd packages/flutter_fixtures_core
        pana --no-warning
        cd ../..
        
        echo "Analyzing flutter_fixtures_dio..."
        cd packages/flutter_fixtures_dio
        pana --no-warning
        cd ../..
        
        echo "Analyzing flutter_fixtures_ui..."
        cd packages/flutter_fixtures_ui
        pana --no-warning
        cd ../..
        
        echo "Analyzing flutter_fixtures..."
        cd packages/flutter_fixtures
        pana --no-warning
        cd ../..

    - name: Check publish readiness
      run: |
        echo "Checking if main package is ready for publishing..."
        cd packages/flutter_fixtures
        dart pub publish --dry-run
        cd ../..

        echo "Checking if flutter_fixtures_core is ready for publishing..."
        cd packages/flutter_fixtures_core
        dart pub publish --dry-run
        cd ../..

        echo "Checking if flutter_fixtures_dio is ready for publishing..."
        cd packages/flutter_fixtures_dio
        dart pub publish --dry-run
        cd ../..

        echo "Checking if flutter_fixtures_ui is ready for publishing..."
        cd packages/flutter_fixtures_ui
        dart pub publish --dry-run
        cd ../..
